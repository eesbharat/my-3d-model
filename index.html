<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GLB Viewer Pro ‚Äî Grouped Tree + Section View</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    display: flex;
    background: linear-gradient(180deg, #f4f4f4, #dcdcdc);
    color: #333;
    font-family: sans-serif;
    overflow: hidden;
  }

  #sidebar {
    width: 260px;
    min-width: 180px;
    max-width: 600px;
    background: #f9f9f9;
    border-right: 1px solid #ccc;
    padding: 10px;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    resize: horizontal;
  }

  #sidebar h3 {
    margin-top: 0;
  }

  #controls {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  #controls button {
    background: #eee;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
  }

  #controls button:hover {
    background: #ddd;
  }

  #viewer {
    flex: 1;
    position: relative;
  }

  canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  ul { padding: 0; margin: 0; }
  li { list-style: none; margin: 4px 0; padding: 4px; border-radius: 4px; }
  li:hover { background: #eaeaea; }
  label, span { display: flex; align-items: center; }
  input[type="checkbox"] { margin-right: 6px; }
</style>
</head>
<body>
  <div id="sidebar">
    <h3>Model Parts</h3>
    <div id="controls">
      <button id="showAll">üëÅ Show All</button>
      <button id="hideAll">üö´ Hide All</button>
    </div>
    <ul id="tree"><li>Loading model...</li></ul>
    <hr>
    <button id="sectionToggle" style="width:100%; background:#eee; border:1px solid #ccc; border-radius:4px; padding:6px; cursor:pointer;">‚úÇÔ∏è Toggle Section View</button>
  </div>
  <div id="viewer"></div>

  <!-- Three.js r128 (Stable Non-Module Version) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>

  <script>
  let scene = new THREE.Scene();
  scene.background = new THREE.Color(0xf0f0f0);

  let camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
  let renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById('viewer').appendChild(renderer.domElement);

  let controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  camera.position.set(3, 3, 5);

  // Lights
  const hemiLight = new THREE.HemisphereLight(0xffffff, 0xaaaaaa, 1.2);
  const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
  dirLight.position.set(5, 10, 7);
  scene.add(hemiLight, dirLight);

  const loader = new THREE.GLTFLoader();
  let model;
  loader.load('model.glb', (gltf) => {
    model = gltf.scene;
    scene.add(model);

    console.log('‚úÖ Model loaded:', model);
    buildTree(model);

    // Fit camera to model
    const box = new THREE.Box3().setFromObject(model);
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);
    const scale = 1.5 / maxDim;
    model.scale.setScalar(scale);
    model.position.sub(center.multiplyScalar(scale));

    camera.position.set(maxDim, maxDim, maxDim);
    controls.target.set(0, 0, 0);
    controls.update();

    model.traverse(obj => {
      if (obj.isMesh) obj.material.side = THREE.DoubleSide;
    });
  }, undefined, (error) => {
    document.getElementById('tree').innerHTML = '<li style="color:red">Error loading model.glb</li>';
    console.error(error);
  });

  // Build grouped parts tree
  function buildTree(object3D) {
    const tree = document.getElementById('tree');
    tree.innerHTML = '';

    const partsMap = new Map();
    object3D.traverse((child) => {
      if (child.isMesh) {
        let parentName = child.parent?.name?.trim();
        if (!parentName || parentName === '') parentName = child.name || '(Unnamed Part)';
        if (!partsMap.has(parentName)) partsMap.set(parentName, []);
        partsMap.get(parentName).push(child);
      }
    });

    if (partsMap.size === 0) {
      const li = document.createElement('li');
      li.textContent = '‚ö†Ô∏è No parts detected.';
      tree.appendChild(li);
      return;
    }

    partsMap.forEach((meshes, name) => {
      const li = document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = true;

      checkbox.addEventListener('change', () => {
        meshes.forEach(m => m.visible = checkbox.checked);
      });

      const label = document.createElement('span');
      label.textContent = name;
      label.style.marginLeft = '6px';

      li.appendChild(checkbox);
      li.appendChild(label);
      tree.appendChild(li);
    });

    // Show/Hide All controls
    document.getElementById('showAll').onclick = () => {
      tree.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = true; cb.dispatchEvent(new Event('change')); });
    };
    document.getElementById('hideAll').onclick = () => {
      tree.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; cb.dispatchEvent(new Event('change')); });
    };

    console.log(`‚úÖ buildTree() grouped into ${partsMap.size} parts.`);
  }

  // Sectional view toggle
  let clippingEnabled = false;
  const sectionButton = document.getElementById('sectionToggle');
  sectionButton.addEventListener('click', () => {
    clippingEnabled = !clippingEnabled;
    renderer.clippingPlanes = clippingEnabled
      ? [new THREE.Plane(new THREE.Vector3(0, -1, 0), 0)]
      : [];
    sectionButton.style.background = clippingEnabled ? '#ffd1d1' : '#eee';
    sectionButton.textContent = clippingEnabled ? '‚úÇÔ∏è Section ON' : '‚úÇÔ∏è Toggle Section View';
  });

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();
  </script>
</body>
</html>